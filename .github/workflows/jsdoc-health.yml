name: JSDoc Health

on:
  schedule:
    # 16:00 UTC = 02:00 AEST / 03:00 AEDT
    - cron: '0 16 * * *'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  health:
    name: JSDoc Quality Report
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Standard env
        uses: ./.github/actions/standard-ci-env

      - name: Setup Bun
        uses: ./.github/actions/setup-bun

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build (includes catalog generation)
        run: bun run build

      - name: Run JSDoc health (Tier 1)
        run: bun run jsdoc:health --json --report .artifacts/jsdoc-health-report.json

      - name: Append summary
        shell: bash
        run: |
          node -e "const fs=require('node:fs'); const r=JSON.parse(fs.readFileSync('.artifacts/jsdoc-health-report.json','utf8')); console.log('## JSDoc Health'); console.log(''); console.log('- Overall: '+r.overallScore+'/100 ('+r.overallRating+')'); console.log('- Modules: '+r.moduleCount); console.log('- Functions: '+r.functionCount);" >> "$GITHUB_STEP_SUMMARY"

      - name: Upload health report
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: jsdoc-health-report
          path: .artifacts/jsdoc-health-report.json
          if-no-files-found: error
          retention-days: 14
