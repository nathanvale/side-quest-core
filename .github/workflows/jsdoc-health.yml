name: JSDoc Health

on:
  schedule:
    # 16:00 UTC = 02:00 AEST / 03:00 AEDT
    - cron: '0 16 * * *'
  workflow_dispatch:
    inputs:
      run_tier2:
        description: Run optional Tier 2 LLM quality checks
        required: false
        type: boolean
        default: false
      llm_strict:
        description: Fail workflow when Tier 2 provider/timeout errors occur
        required: false
        type: boolean
        default: false
      tier2_provider:
        description: Tier 2 provider backend
        required: false
        type: choice
        options:
          - openai
          - anthropic
        default: openai
      max_modules:
        description: Tier 2 module budget
        required: false
        type: string
        default: '3'
      max_functions:
        description: Tier 2 function budget
        required: false
        type: string
        default: '40'
      max_tokens:
        description: Tier 2 token budget
        required: false
        type: string
        default: '120000'
      timeout_ms:
        description: Tier 2 timeout budget in milliseconds
        required: false
        type: string
        default: '600000'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  actions: read
  contents: read
  issues: write

jobs:
  health:
    name: JSDoc Quality Report
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Standard env
        uses: ./.github/actions/standard-ci-env

      - name: Setup Bun
        uses: ./.github/actions/setup-bun

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build (includes catalog generation)
        run: bun run build

      - name: Run JSDoc health
        shell: bash
        env:
          RUN_TIER2: ${{ inputs.run_tier2 }}
          LLM_STRICT: ${{ inputs.llm_strict }}
          TIER2_PROVIDER: ${{ inputs.tier2_provider }}
          MAX_MODULES: ${{ inputs.max_modules }}
          MAX_FUNCTIONS: ${{ inputs.max_functions }}
          MAX_TOKENS: ${{ inputs.max_tokens }}
          TIMEOUT_MS: ${{ inputs.timeout_ms }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          JSDOC_HEALTH_MODEL: ${{ vars.JSDOC_HEALTH_MODEL }}
        run: |
          run_tier2="${RUN_TIER2:-false}"
          llm_strict="${LLM_STRICT:-false}"
          tier2_provider="${TIER2_PROVIDER:-openai}"
          max_modules="${MAX_MODULES:-3}"
          max_functions="${MAX_FUNCTIONS:-40}"
          max_tokens="${MAX_TOKENS:-120000}"
          timeout_ms="${TIMEOUT_MS:-600000}"

          cmd=(bun run jsdoc:health --json --report .artifacts/jsdoc-health-report.json)

          if [[ "$GITHUB_EVENT_NAME" == "workflow_dispatch" && "$run_tier2" == "true" ]]; then
            export JSDOC_HEALTH_PROVIDER="$tier2_provider"
            cmd+=(--llm --max-modules "$max_modules" --max-functions "$max_functions" --max-tokens "$max_tokens" --timeout-ms "$timeout_ms")
            if [[ "$llm_strict" == "true" ]]; then
              cmd+=(--llm-strict)
            fi
          fi

          printf 'Running command:'
          printf ' %q' "${cmd[@]}"
          echo
          "${cmd[@]}"

      - name: Locate baseline report artifact
        id: baseline_lookup
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const workflowId = 'jsdoc-health.yml'
            const artifactName = 'jsdoc-health-report'

            try {
              const runs = await github.paginate(github.rest.actions.listWorkflowRuns, {
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: workflowId,
                branch: 'main',
                event: 'schedule',
                per_page: 100,
              })

              for (const run of runs) {
                if (run.conclusion !== 'success' || run.id === context.runId) {
                  continue
                }

                const artifacts = await github.paginate(
                  github.rest.actions.listWorkflowRunArtifacts,
                  {
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    run_id: run.id,
                    per_page: 100,
                  },
                )

                const artifact = artifacts.find(
                  (candidate) =>
                    candidate.name === artifactName && candidate.expired === false,
                )

                if (artifact) {
                  core.setOutput('found', 'true')
                  core.setOutput('archive_url', artifact.archive_download_url)
                  core.setOutput('run_id', String(run.id))
                  core.setOutput('run_url', run.html_url)
                  core.info(`Using baseline from run ${run.id}`)
                  return
                }
              }
            } catch (error) {
              core.warning(`Baseline lookup failed: ${error instanceof Error ? error.message : String(error)}`)
            }

            core.setOutput('found', 'false')

      - name: Download baseline report artifact
        if: steps.baseline_lookup.outputs.found == 'true'
        shell: bash
        env:
          ARCHIVE_URL: ${{ steps.baseline_lookup.outputs.archive_url }}
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          mkdir -p .artifacts/baseline-unpack

          if ! curl -fsSL \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "${ARCHIVE_URL}" \
            -o .artifacts/baseline-jsdoc-health.zip; then
            echo "::warning::Unable to download baseline artifact archive"
            exit 0
          fi

          if ! unzip -q .artifacts/baseline-jsdoc-health.zip -d .artifacts/baseline-unpack; then
            echo "::warning::Unable to unzip baseline artifact archive"
            exit 0
          fi

          baseline_file="$(find .artifacts/baseline-unpack -type f -name 'jsdoc-health-report.json' | head -n 1)"
          if [[ -z "$baseline_file" ]]; then
            echo "::warning::Baseline artifact archive did not contain jsdoc-health-report.json"
            exit 0
          fi

          cp "$baseline_file" .artifacts/baseline-jsdoc-health-report.json

      - name: Compare JSDoc health scores
        id: compare_scores
        shell: bash
        run: |
          node <<'NODE'
          const fs = require('node:fs')

          const outputPath = process.env.GITHUB_OUTPUT
          const summaryPath = process.env.GITHUB_STEP_SUMMARY
          const threshold = 10
          const currentPath = '.artifacts/jsdoc-health-report.json'
          const baselinePath = '.artifacts/baseline-jsdoc-health-report.json'

          const current = JSON.parse(fs.readFileSync(currentPath, 'utf8'))
          const currentScore = Number(current.overallScore)

          let baselineAvailable = fs.existsSync(baselinePath)
          let baselineScore = NaN
          let delta = NaN
          let dropExceeded = false

          if (baselineAvailable) {
            const baseline = JSON.parse(fs.readFileSync(baselinePath, 'utf8'))
            baselineScore = Number(baseline.overallScore)
            delta = Number((currentScore - baselineScore).toFixed(2))
            dropExceeded = delta < -threshold
          }

          const outputs = [
            `baseline_available=${baselineAvailable}`,
            `current_score=${currentScore}`,
            `baseline_score=${baselineAvailable ? baselineScore : ''}`,
            `delta=${baselineAvailable ? delta : ''}`,
            `threshold=${threshold}`,
            `drop_exceeded=${dropExceeded}`,
          ]
          fs.appendFileSync(outputPath, outputs.join('\n') + '\n')

          const summary = []
          summary.push('### JSDoc Health Baseline Comparison')
          summary.push('')
          summary.push(`- Current overall score: ${currentScore}`)
          if (!baselineAvailable) {
            summary.push('- Baseline overall score: unavailable')
            summary.push('- Delta: unavailable (no successful scheduled run artifact found on main)')
          } else {
            summary.push(`- Baseline overall score: ${baselineScore}`)
            summary.push(`- Delta: ${delta}`)
            summary.push(`- Regression threshold: -${threshold}`)
            summary.push(`- Drop exceeds threshold: ${dropExceeded ? 'yes' : 'no'}`)
          }

          fs.appendFileSync(summaryPath, summary.join('\n') + '\n')
          NODE

      - name: Open or update regression issue
        if: steps.compare_scores.outputs.drop_exceeded == 'true'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const fs = require('node:fs')

            try {
              const reportPath = '.artifacts/jsdoc-health-report.json'
              if (!fs.existsSync(reportPath)) {
                core.warning('Report file missing, skipping issue automation.')
                return
              }

              const baselinePath = '.artifacts/baseline-jsdoc-health-report.json'
              if (!fs.existsSync(baselinePath)) {
                core.warning('Baseline report missing, skipping issue automation.')
                return
              }

              const current = JSON.parse(fs.readFileSync(reportPath, 'utf8'))
              const baseline = JSON.parse(fs.readFileSync(baselinePath, 'utf8'))
              const currentScore = Number(current.overallScore)
              const baselineScore = Number(baseline.overallScore)
              const delta = Number((currentScore - baselineScore).toFixed(2))
              const threshold = 10

              if (!(delta < -threshold)) {
                core.info('Regression threshold not exceeded.')
                return
              }

              const title = 'JSDoc health score regression detected'
              const labelName = 'jsdoc-health'
              const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
              const baselineRunUrl = '${{ steps.baseline_lookup.outputs.run_url }}'
              const topIssues = Array.isArray(current.topIssues)
                ? current.topIssues
                    .slice(0, 3)
                    .map(
                      (issue, index) =>
                        `${index + 1}. ${issue.label ?? issue.code ?? 'Unknown issue'} (${issue.count ?? 0})`,
                    )
                    .join('\n')
                : '1. No top issues available'

              const body = [
                'Automated JSDoc quality regression alert.',
                '',
                `- Baseline overall score: ${baselineScore}`,
                `- Current overall score: ${currentScore}`,
                `- Delta: ${delta}`,
                `- Threshold: -${threshold}`,
                `- Current run: ${runUrl}`,
                baselineRunUrl ? `- Baseline run: ${baselineRunUrl}` : '- Baseline run: unavailable',
                '',
                'Top current issues:',
                topIssues,
                '',
                'Action: review recent JSDoc changes and prioritize low-scoring modules.',
              ].join('\n')

              try {
                await github.rest.issues.getLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: labelName,
                })
              } catch (error) {
                if (error.status === 404) {
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: labelName,
                    color: 'B60205',
                    description: 'Automated JSDoc health tracking',
                  })
                } else {
                  throw error
                }
              }

              const openIssues = await github.paginate(github.rest.issues.listForRepo, {
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: labelName,
                per_page: 100,
              })
              const existing = openIssues.find(
                (issue) => !issue.pull_request && issue.title === title,
              )

              if (existing) {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existing.number,
                  body,
                })
                core.info(`Updated regression issue #${existing.number}`)
                return
              }

              const created = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: [labelName],
              })
              core.info(`Created regression issue #${created.data.number}`)
            } catch (error) {
              core.warning(`Regression issue automation failed: ${error instanceof Error ? error.message : String(error)}`)
            }

      - name: Append summary
        shell: bash
        run: |
          node -e "const fs=require('node:fs'); const r=JSON.parse(fs.readFileSync('.artifacts/jsdoc-health-report.json','utf8')); console.log('## JSDoc Health'); console.log(''); console.log('- Overall: '+r.overallScore+'/100 ('+r.overallRating+')'); console.log('- Modules: '+r.moduleCount); console.log('- Functions: '+r.functionCount); if (r.tier2) { const tier2Score = r.tier2.score === null ? 'n/a' : r.tier2.score + '/100'; console.log('- Tier 2: '+r.tier2.status+' ('+tier2Score+')'); if (r.tier2.stopReason) console.log('- Tier 2 stop reason: '+r.tier2.stopReason); } if (Array.isArray(r.warnings) && r.warnings.length > 0) { console.log('- Warnings: '+r.warnings.length); }" >> "$GITHUB_STEP_SUMMARY"

      - name: Upload health report
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: jsdoc-health-report
          path: .artifacts/jsdoc-health-report.json
          if-no-files-found: error
          retention-days: 14
